{"version":3,"sources":["../../../src/server/files/get.js"],"names":["getIpfs","opts","get","pre","files","map","file","content","getPullStream","res","Promise","resolve","readFnName","pull","PMS","sink","Object","assign","post","data"],"mappings":";;;;;;kBASe,UAAUA,OAAV,EAAmBC,IAAnB,EAAyB;AACtC,SAAO;AACLC,SAAK,wBAAO,gBAAP,EAAyB,kBAC5B,+BAAkB,CAAlB,CAD4B,EAE5B,yBAAe,CAAf,CAF4B,EAG5BD,KAAKE,GAAL,CAAS,WAAT,CAH4B,EAI5B,mBACE;AAAA;;AAAA,aAAa,4BAAUC,KAAV,EAAgBF,GAAhB,iCAAb;AAAA,KADF,EAEE,UAACE,KAAD;AAAA,aAAWA,MAAMC,GAAN,CAAU,UAACC,IAAD,EAAU;AAC7B,YAAIA,KAAKC,OAAT,EAAkB;AAChBD,eAAKC,OAAL,GAAe,0BAAaD,KAAKC,OAAlB,CAAf;AACD;;AAED,eAAOD,IAAP;AACD,OANU,CAAX;AAAA,KAFF,CAJ4B,CAAzB,EAcFL,IAdE,CADA;AAgBLO,mBAAe,wBAAO,0BAAP,EAAmC,kBAChD,+BAAkB,CAAlB,CADgD,EAEhD,yBAAe,CAAf,CAFgD,EAGhDP,KAAKE,GAAL,CAAS,qBAAT,CAHgD,EAIhD,mBACE;AAAA;;AAAA,aAAa,6BAAUC,KAAV,EAAgBI,aAAhB,kCAAb;AAAA,KADF,EAEE,UAACC,GAAD;AAAA,aAAS,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAa;AAChC,YAAMC,aAAa,wBAAnB;;AAEA,kCACEH,GADF,EAEEI,qBAAKR,GAAL,CAAS,UAACC,IAAD,EAAU;AACjB,cAAIA,KAAKC,OAAT,EAAkB;AAChB,gBAAMK,cAAa,wBAAnB;;AAEA,sCACEN,KAAKC,OADP,EAEEO,4BAAIC,IAAJ,CAASH,WAAT,EAAqBI,OAAOC,MAAP,CAAc,EAAd,EAAkBhB,IAAlB,EAAwB;AAC3CiB,kBAD2C,gBACrCT,GADqC,EAChC;AACT,oBAAI,sBAASA,IAAIU,IAAb,CAAJ,EAAwB;AACtBV,sBAAIU,IAAJ,GAAW,0BAAaV,IAAIU,IAAjB,CAAX;AACD;;AAED,uBAAOV,GAAP;AACD;AAP0C,aAAxB,CAArB,CAFF;;AAaAH,iBAAKC,OAAL,GAAe,8BAAeK,WAAf,CAAf;AACD;;AAED,iBAAON,IAAP;AACD,SArBD,CAFF,EAwBEQ,4BAAIC,IAAJ,CAASH,UAAT,EAAqBX,IAArB,CAxBF;;AA2BAU,gBAAQ,8BAAeC,UAAf,CAAR;AACD,OA/BQ,CAAT;AAAA,KAFF,CAJgD,CAAnC,EAuCZX,IAvCY;AAhBV,GAAP;AAyDD,C;;AAnED;;AACA;;AACA;;;;AACA;;;;AACA;;;;AACA;;AACA;;AACA","file":"get.js","sourcesContent":["import { expose } from 'postmsg-rpc'\nimport { pre, post } from 'prepost'\nimport pull from 'pull-stream'\nimport PMS from 'pull-postmsg-stream'\nimport shortid from 'shortid'\nimport { preCidFromJson } from '../../serialization/cid'\nimport { isBuffer, preBufferFromJson, bufferToJson } from '../../serialization/buffer'\nimport { functionToJson } from '../../serialization/function'\n\nexport default function (getIpfs, opts) {\n  return {\n    get: expose('ipfs.files.get', pre(\n      preBufferFromJson(0),\n      preCidFromJson(0),\n      opts.pre('files.get'),\n      post(\n        (...args) => getIpfs().files.get(...args),\n        (files) => files.map((file) => {\n          if (file.content) {\n            file.content = bufferToJson(file.content)\n          }\n\n          return file\n        })\n      )\n    ), opts),\n    getPullStream: expose('ipfs.files.getPullStream', pre(\n      preBufferFromJson(0),\n      preCidFromJson(0),\n      opts.pre('files.getPullStream'),\n      post(\n        (...args) => getIpfs().files.getPullStream(...args),\n        (res) => new Promise((resolve) => {\n          const readFnName = shortid()\n\n          pull(\n            res,\n            pull.map((file) => {\n              if (file.content) {\n                const readFnName = shortid()\n\n                pull(\n                  file.content,\n                  PMS.sink(readFnName, Object.assign({}, opts, {\n                    post (res) {\n                      if (isBuffer(res.data)) {\n                        res.data = bufferToJson(res.data)\n                      }\n\n                      return res\n                    }\n                  }))\n                )\n\n                file.content = functionToJson(readFnName)\n              }\n\n              return file\n            }),\n            PMS.sink(readFnName, opts)\n          )\n\n          resolve(functionToJson(readFnName))\n        })\n      )\n    ), opts)\n  }\n}\n"]}