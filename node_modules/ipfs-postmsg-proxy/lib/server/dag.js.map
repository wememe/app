{"version":3,"sources":["../../src/server/dag.js"],"names":["getIpfs","opts","put","args","isBufferJson","bufferFromJson","cid","pre","dag","cidToJson","get","res","value","isBuffer","bufferToJson","tree"],"mappings":";;;;;;kBAOe,UAAUA,OAAV,EAAmBC,IAAnB,EAAyB;AACtC,SAAO;AACLC,SAAK,wBAAO,cAAP,EAAuB,kBAC1B,6BAAmB,CAAnB,CAD0B,EAE1B,YAAa;AAAA,wCAATC,IAAS;AAATA,YAAS;AAAA;;AACX;AACA,UAAIA,KAAK,CAAL,KAAW,CAAC,oBAAUA,KAAK,CAAL,CAAV,CAAhB,EAAoC;AAClCA,aAAK,CAAL,IAAU,6BAAcA,KAAK,CAAL,CAAd,EAAuBC,oBAAvB,EAAqCC,sBAArC,CAAV;AACD;;AAED,UAAIF,KAAK,CAAL,KAAWA,KAAK,CAAL,EAAQG,GAAvB,EAA4B;AAC1B,YAAI,0BAAaH,KAAK,CAAL,EAAQG,GAArB,CAAJ,EAA+B;AAC7BH,eAAK,CAAL,EAAQG,GAAR,GAAc,4BAAeH,KAAK,CAAL,EAAQG,GAAvB,CAAd;AACD,SAFD,MAEO,IAAI,oBAAUH,KAAK,CAAL,EAAQG,GAAlB,CAAJ,EAA4B;AACjCH,eAAK,CAAL,EAAQG,GAAR,GAAc,sBAAYH,KAAK,CAAL,EAAQG,GAApB,CAAd;AACD;AACF;;AAED,aAAOH,IAAP;AACD,KAjByB,EAkB1BF,KAAKM,GAAL,CAAS,SAAT,CAlB0B,EAmB1B,mBACE;AAAA;;AAAA,aAAa,0BAAUC,GAAV,EAAcN,GAAd,+BAAb;AAAA,KADF,EAEEO,cAFF,CAnB0B,CAAvB,EAuBFR,IAvBE,CADA;AAyBLS,SAAK,wBAAO,cAAP,EAAuB,kBAC1B,+BAAkB,CAAlB,CAD0B,EAE1B,yBAAe,CAAf,CAF0B,EAG1BT,KAAKM,GAAL,CAAS,SAAT,CAH0B,EAI1B,mBACE;AAAA;;AAAA,aAAa,2BAAUC,GAAV,EAAcE,GAAd,gCAAb;AAAA,KADF,EAEE,UAACC,GAAD,EAAS;AACP,UAAI,oBAAUA,IAAIC,KAAd,CAAJ,EAA0B;AACxBD,YAAIC,KAAJ,GAAY,wBAAcD,IAAIC,KAAlB,CAAZ;AACD,OAFD,MAEO,IAAI,sBAASD,IAAIC,KAAb,CAAJ,EAAyB;AAC9BD,YAAIC,KAAJ,GAAY,0BAAaD,IAAIC,KAAjB,CAAZ;AACD,OAFM,MAEA;AACLD,YAAIC,KAAJ,GAAY,6BAAcD,IAAIC,KAAlB,EAAyBC,gBAAzB,EAAmCC,oBAAnC,CAAZ;AACD;;AAED,aAAOH,GAAP;AACD,KAZH,CAJ0B,CAAvB,EAkBFV,IAlBE,CAzBA;AA4CLc,UAAM,wBAAO,eAAP,EAAwB,kBAC5B,+BAAkB,CAAlB,CAD4B,EAE5B,yBAAe,CAAf,CAF4B,EAG5Bd,KAAKM,GAAL,CAAS,UAAT,CAH4B,EAI5B;AAAA;;AAAA,aAAa,2BAAUC,GAAV,EAAcO,IAAd,gCAAb;AAAA,KAJ4B,CAAxB,EAKHd,IALG;AA5CD,GAAP;AAmDD,C;;AA3DD;;AACA;;AACA;;AACA;;AACA;;AACA","file":"dag.js","sourcesContent":["import { expose } from 'postmsg-rpc'\nimport { pre, post } from 'prepost'\nimport { isDagNode, dagNodeToJson, preDagNodeFromJson } from '../serialization/dag'\nimport { isCidJson, cidToJson, cidFromJson, preCidFromJson } from '../serialization/cid'\nimport { isBuffer, isBufferJson, bufferFromJson, preBufferFromJson, bufferToJson } from '../serialization/buffer'\nimport convertValues from '../serialization/utils/convert-values'\n\nexport default function (getIpfs, opts) {\n  return {\n    put: expose('ipfs.dag.put', pre(\n      preDagNodeFromJson(0),\n      (...args) => {\n        // TODO: CBOR node, is this correct?\n        if (args[0] && !isDagNode(args[0])) {\n          args[0] = convertValues(args[0], isBufferJson, bufferFromJson)\n        }\n\n        if (args[1] && args[1].cid) {\n          if (isBufferJson(args[1].cid)) {\n            args[1].cid = bufferFromJson(args[1].cid)\n          } else if (isCidJson(args[1].cid)) {\n            args[1].cid = cidFromJson(args[1].cid)\n          }\n        }\n\n        return args\n      },\n      opts.pre('dag.put'),\n      post(\n        (...args) => getIpfs().dag.put(...args),\n        cidToJson\n      )\n    ), opts),\n    get: expose('ipfs.dag.get', pre(\n      preBufferFromJson(0),\n      preCidFromJson(0),\n      opts.pre('dag.get'),\n      post(\n        (...args) => getIpfs().dag.get(...args),\n        (res) => {\n          if (isDagNode(res.value)) {\n            res.value = dagNodeToJson(res.value)\n          } else if (isBuffer(res.value)) {\n            res.value = bufferToJson(res.value)\n          } else {\n            res.value = convertValues(res.value, isBuffer, bufferToJson)\n          }\n\n          return res\n        }\n      )\n    ), opts),\n    tree: expose('ipfs.dag.tree', pre(\n      preBufferFromJson(0),\n      preCidFromJson(0),\n      opts.pre('dag.tree'),\n      (...args) => getIpfs().dag.tree(...args)\n    ), opts)\n  }\n}\n"]}