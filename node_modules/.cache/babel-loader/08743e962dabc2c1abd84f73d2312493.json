{"ast":null,"code":"var ready = require('./ready');\n/**\n  ### `sink(socket, opts?)`\n\n  Create a pull-stream `Sink` that will write data to the `socket`.\n\n  <<< examples/write.js\n\n**/\n\n\nvar nextTick = typeof setImmediate !== 'undefined' ? setImmediate : process.nextTick;\n\nmodule.exports = function (socket, opts) {\n  return function (read) {\n    opts = opts || {};\n    var closeOnEnd = opts.closeOnEnd !== false;\n    var onClose = 'function' === typeof opts ? opts : opts.onClose;\n\n    function next(end, data) {\n      // if the stream has ended, simply return\n      if (end) {\n        if (closeOnEnd && socket.readyState <= 1) {\n          if (onClose) socket.addEventListener('close', function (ev) {\n            if (ev.wasClean || ev.code === 1006) onClose();else {\n              var err = new Error('ws error');\n              err.event = ev;\n              onClose(err);\n            }\n          });\n          socket.close();\n        }\n\n        return;\n      } // socket ready?\n\n\n      ready(socket, function (end) {\n        if (end) {\n          return read(end, function () {});\n        }\n\n        socket.send(data);\n        nextTick(function () {\n          read(null, next);\n        });\n      });\n    }\n\n    read(null, next);\n  };\n};","map":null,"metadata":{},"sourceType":"script"}