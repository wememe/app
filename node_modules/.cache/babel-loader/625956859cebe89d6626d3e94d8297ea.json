{"ast":null,"code":"'use strict';\n\nvar pull = require('pull-stream');\n\nvar pushable = require('pull-pushable');\n\nvar pullPair = require('pull-pair');\n\nvar batch = require('pull-batch');\n\nmodule.exports = function balancedReduceToRoot(reduce, options) {\n  var pair = pullPair();\n  var source = pair.source;\n  var result = pushable();\n  reduceToParents(source, function (err, roots) {\n    if (err) {\n      result.end(err);\n      return; // early\n    }\n\n    if (roots.length === 1) {\n      result.push(roots[0]);\n      result.end();\n    } else if (roots.length > 1) {\n      result.end(new Error('expected a maximum of 1 roots and got ' + roots.length));\n    } else {\n      result.end();\n    }\n  });\n\n  function reduceToParents(_chunks, callback) {\n    var chunks = _chunks;\n\n    if (Array.isArray(chunks)) {\n      chunks = pull.values(chunks);\n    }\n\n    pull(chunks, batch(options.maxChildrenPerNode), pull.asyncMap(reduce), pull.collect(reduced));\n\n    function reduced(err, roots) {\n      if (err) {\n        callback(err);\n      } else if (roots.length > 1) {\n        reduceToParents(roots, callback);\n      } else {\n        callback(null, roots);\n      }\n    }\n  }\n\n  return {\n    sink: pair.sink,\n    source: result\n  };\n};","map":null,"metadata":{},"sourceType":"script"}