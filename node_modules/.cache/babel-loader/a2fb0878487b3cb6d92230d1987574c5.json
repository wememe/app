{"ast":null,"code":"'use strict';\n\nvar debug = require('debug');\n\nvar setImmediate = require('async/setImmediate');\n\nvar log = debug('repo:lock');\nvar lockFile = 'repo.lock';\nvar LOCKS = {};\n/**\n * Lock the repo in the given dir.\n *\n * @param {string} dir\n * @param {function(Error, lock)} callback\n * @returns {void}\n */\n\nexports.lock = function (dir, callback) {\n  var file = dir + '/' + lockFile;\n  log('locking %s', file);\n  LOCKS[file] = true;\n  var closer = {\n    close: function close(cb) {\n      if (LOCKS[file]) {\n        delete LOCKS[file];\n      }\n\n      setImmediate(cb);\n    }\n  };\n  setImmediate(function () {\n    callback(null, closer);\n  });\n};\n/**\n * Check if the repo in the given directory is locked.\n *\n * @param {string} dir\n * @param {function(Error, bool)} callback\n * @returns {void}\n */\n\n\nexports.locked = function (dir, callback) {\n  var file = dir + '/' + lockFile;\n  log('checking lock: %s');\n  var locked = LOCKS[file];\n  setImmediate(function () {\n    callback(null, locked);\n  });\n};","map":null,"metadata":{},"sourceType":"script"}