{"ast":null,"code":"'use strict';\n\nvar waterfall = require('async/waterfall');\n\nvar dagPB = require('ipld-dag-pb');\n\nvar UnixFS = require('ipfs-unixfs');\n\nvar CID = require('cids');\n\nvar DAGLink = dagPB.DAGLink;\nvar DAGNode = dagPB.DAGNode;\n\nmodule.exports = function reduce(file, ipld, options) {\n  return function (leaves, callback) {\n    if (leaves.length === 1 && leaves[0].single && options.reduceSingleLeafToSelf) {\n      var leaf = leaves[0];\n      return callback(null, {\n        path: file.path,\n        multihash: leaf.multihash,\n        size: leaf.size,\n        leafSize: leaf.leafSize,\n        name: leaf.name\n      });\n    } // create a parent node and add all the leaves\n\n\n    var f = new UnixFS('file');\n    var links = leaves.map(function (leaf) {\n      f.addBlockSize(leaf.leafSize);\n      var cid = leaf.cid;\n\n      if (!cid) {\n        // we are an intermediate node\n        cid = new CID(options.cidVersion, 'dag-pb', leaf.multihash);\n      }\n\n      return new DAGLink(leaf.name, leaf.size, cid.buffer);\n    });\n    waterfall([function (cb) {\n      return DAGNode.create(f.marshal(), links, options.hashAlg, cb);\n    }, function (node, cb) {\n      var cid = new CID(options.cidVersion, 'dag-pb', node.multihash);\n\n      if (options.onlyHash) {\n        return cb(null, {\n          node: node,\n          cid: cid\n        });\n      }\n\n      ipld.put(node, {\n        cid: cid\n      }, function (error) {\n        return cb(error, {\n          node: node,\n          cid: cid\n        });\n      });\n    }], function (error, result) {\n      if (error) {\n        return callback(error);\n      }\n\n      callback(null, {\n        name: '',\n        path: file.path,\n        multihash: result.cid.buffer,\n        size: result.node.size,\n        leafSize: f.fileSize()\n      });\n    });\n  };\n};","map":null,"metadata":{},"sourceType":"script"}