{"ast":null,"code":"'use strict';\n\nvar Buffer = require('safe-buffer').Buffer;\n\nmodule.exports = encode;\nvar poolSize = 10 * 1024;\n\nfunction encode(opts) {\n  opts = Object.assign({\n    fixed: false\n  }, opts || {}); // Only needed for varint\n\n  var varint = require('varint');\n\n  var pool = opts.fixed ? null : createPool();\n  var used = 0;\n  var ended = false;\n  return function (read) {\n    return function (end, cb) {\n      if (end) ended = end;\n      if (ended) return cb(ended);\n      read(null, function (end, data) {\n        if (end) ended = end;\n        if (ended) return cb(ended);\n\n        if (!Buffer.isBuffer(data)) {\n          ended = new Error('data must be a buffer');\n          return cb(ended);\n        }\n\n        var encodedLength;\n\n        if (opts.fixed) {\n          encodedLength = Buffer.alloc(4);\n          encodedLength.writeInt32BE(data.length, 0); // writes exactly 4 bytes\n        } else {\n          varint.encode(data.length, pool, used);\n          used += varint.encode.bytes;\n          encodedLength = pool.slice(used - varint.encode.bytes, used);\n\n          if (pool.length - used < 100) {\n            pool = createPool();\n            used = 0;\n          }\n        }\n\n        cb(null, Buffer.concat([encodedLength, data]));\n      });\n    };\n  };\n}\n\nfunction createPool() {\n  return Buffer.alloc(poolSize);\n}","map":null,"metadata":{},"sourceType":"script"}