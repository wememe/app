{"ast":null,"code":"'use strict';\n\nvar _classCallCheck = require(\"/Users/kenzo/Desktop/3box-dapp/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"/Users/kenzo/Desktop/3box-dapp/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createClass\");\n\nvar mafmt = require('mafmt');\n\nvar multiaddr = require('multiaddr');\n\nvar CircuitDialer = require('./circuit/dialer');\n\nvar utilsFactory = require('./circuit/utils');\n\nvar debug = require('debug');\n\nvar log = debug('libp2p:circuit:transportdialer');\nlog.err = debug('libp2p:circuit:error:transportdialer');\n\nvar _createListener = require('./listener');\n\nvar Circuit =\n/*#__PURE__*/\nfunction () {\n  _createClass(Circuit, null, [{\n    key: \"tag\",\n    get: function get() {\n      return 'Circuit';\n    }\n    /**\n     * Creates an instance of Dialer.\n     *\n     * @param {Swarm} swarm - the swarm\n     * @param {any} options - config options\n     *\n     * @memberOf Dialer\n     */\n\n  }]);\n\n  function Circuit(swarm, options) {\n    var _this = this;\n\n    _classCallCheck(this, Circuit);\n\n    this.options = options || {};\n    this.swarm = swarm;\n    this.dialer = null;\n    this.utils = utilsFactory(swarm);\n    this.peerInfo = this.swarm._peerInfo;\n    this.relays = this.filter(this.peerInfo.multiaddrs.toArray()); // if no explicit relays, add a default relay addr\n\n    if (this.relays.length === 0) {\n      this.peerInfo.multiaddrs.add(\"/p2p-circuit/ipfs/\".concat(this.peerInfo.id.toB58String()));\n    }\n\n    this.dialer = new CircuitDialer(swarm, options);\n    this.swarm.on('peer-mux-established', this.dialer.canHop.bind(this.dialer));\n    this.swarm.on('peer-mux-closed', function (peerInfo) {\n      _this.dialer.relayPeers.delete(peerInfo.id.toB58String());\n    });\n  }\n  /**\n   * Dial the relays in the Addresses.Swarm config\n   *\n   * @param {Array} relays\n   * @return {void}\n   */\n\n\n  _createClass(Circuit, [{\n    key: \"_dialSwarmRelays\",\n    value: function _dialSwarmRelays() {\n      var _this2 = this;\n\n      // if we have relay addresses in swarm config, then dial those relays\n      this.relays.forEach(function (relay) {\n        var relaySegments = relay.toString().split('/p2p-circuit').filter(function (segment) {\n          return segment.length;\n        });\n        relaySegments.forEach(function (relaySegment) {\n          var ma = _this2.utils.peerInfoFromMa(multiaddr(relaySegment));\n\n          _this2.dialer._dialRelay(ma);\n        });\n      });\n    }\n    /**\n     * Dial a peer over a relay\n     *\n     * @param {multiaddr} ma - the multiaddr of the peer to dial\n     * @param {Object} options - dial options\n     * @param {Function} cb - a callback called once dialed\n     * @returns {Connection} - the connection\n     *\n     * @memberOf Dialer\n     */\n\n  }, {\n    key: \"dial\",\n    value: function dial(ma, options, cb) {\n      return this.dialer.dial(ma, options, cb);\n    }\n    /**\n     * Create a listener\n     *\n     * @param {any} options\n     * @param {Function} handler\n     * @return {listener}\n     */\n\n  }, {\n    key: \"createListener\",\n    value: function createListener(options, handler) {\n      if (typeof options === 'function') {\n        handler = options;\n        options = this.options || {};\n      }\n\n      var listener = _createListener(this.swarm, options, handler);\n\n      listener.on('listen', this._dialSwarmRelays.bind(this));\n      return listener;\n    }\n    /**\n     * Filter check for all multiaddresses\n     * that this transport can dial on\n     *\n     * @param {any} multiaddrs\n     * @returns {Array<multiaddr>}\n     *\n     * @memberOf Dialer\n     */\n\n  }, {\n    key: \"filter\",\n    value: function filter(multiaddrs) {\n      if (!Array.isArray(multiaddrs)) {\n        multiaddrs = [multiaddrs];\n      }\n\n      return multiaddrs.filter(function (ma) {\n        return mafmt.Circuit.matches(ma);\n      });\n    }\n  }]);\n\n  return Circuit;\n}();\n\nmodule.exports = Circuit;","map":null,"metadata":{},"sourceType":"script"}