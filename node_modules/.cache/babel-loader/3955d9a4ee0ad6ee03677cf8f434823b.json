{"ast":null,"code":"var looper = require('looper');\n\nmodule.exports = function (map, width, inOrder) {\n  inOrder = inOrder === undefined ? true : inOrder;\n  var reading = false,\n      abort;\n  return function (read) {\n    var i = 0,\n        j = 0,\n        last = 0;\n\n    var seen = [],\n        started = false,\n        ended = false,\n        _cb,\n        error;\n\n    function drain() {\n      if (_cb) {\n        var cb = _cb;\n\n        if (error) {\n          _cb = null;\n          return cb(error);\n        }\n\n        if (Object.hasOwnProperty.call(seen, j)) {\n          _cb = null;\n          var data = seen[j];\n          delete seen[j];\n          j++;\n          cb(null, data);\n          if (width) start();\n        } else if (j >= last && ended) {\n          _cb = null;\n          cb(ended);\n        }\n      }\n    }\n\n    var start = looper(function () {\n      started = true;\n      if (ended) return drain();\n      if (reading || width && i - width >= j) return;\n      reading = true;\n      read(abort, function (end, data) {\n        reading = false;\n\n        if (end) {\n          last = i;\n          ended = end;\n          drain();\n        } else {\n          var k = i++;\n          map(data, function (err, data) {\n            if (inOrder) seen[k] = data;else seen.push(data);\n            if (err) error = err;\n            drain();\n          });\n          if (!ended) start();\n        }\n      });\n    });\n    return function (_abort, cb) {\n      if (_abort) read(ended = abort = _abort, function (err) {\n        if (cb) return cb(err);\n      });else {\n        _cb = cb;\n        if (!started) start();\n        drain();\n      }\n    };\n  };\n};","map":null,"metadata":{},"sourceType":"script"}