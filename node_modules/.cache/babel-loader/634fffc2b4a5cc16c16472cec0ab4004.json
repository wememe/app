{"ast":null,"code":"var util = require('util');\n\nvar AbstractLevelDOWN = require('abstract-leveldown').AbstractLevelDOWN;\n\nvar DeferredIterator = require('./deferred-iterator');\n\nvar deferrables = 'put get del batch'.split(' ');\n\nfunction DeferredLevelDOWN(db) {\n  AbstractLevelDOWN.call(this, '');\n  this._db = db;\n  this._operations = [];\n  this._iterators = [];\n  closed(this);\n}\n\nutil.inherits(DeferredLevelDOWN, AbstractLevelDOWN);\n\nDeferredLevelDOWN.prototype._open = function (options, callback) {\n  var self = this;\n\n  this._db.open(options, function (err) {\n    if (err) return callback(err);\n\n    self._operations.forEach(function (op) {\n      self._db[op.method].apply(self._db, op.args);\n    });\n\n    self._operations = [];\n\n    self._iterators.forEach(function (it) {\n      it.setDb(self._db);\n    });\n\n    self._iterators = [];\n    open(self);\n    callback();\n  });\n};\n\nDeferredLevelDOWN.prototype._close = function (callback) {\n  var self = this;\n\n  this._db.close(function (err) {\n    if (err) return callback(err);\n    closed(self);\n    callback();\n  });\n};\n\nfunction open(self) {\n  deferrables.concat('iterator').forEach(function (m) {\n    self['_' + m] = function () {\n      return this._db[m].apply(this._db, arguments);\n    };\n  });\n\n  if (self._db.approximateSize) {\n    self.approximateSize = function () {\n      return this._db.approximateSize.apply(this._db, arguments);\n    };\n  }\n}\n\nfunction closed(self) {\n  deferrables.forEach(function (m) {\n    self['_' + m] = function () {\n      this._operations.push({\n        method: m,\n        args: arguments\n      });\n    };\n  });\n\n  if (typeof self._db.approximateSize === 'function') {\n    self.approximateSize = function () {\n      this._operations.push({\n        method: 'approximateSize',\n        args: arguments\n      });\n    };\n  }\n\n  self._iterator = function (options) {\n    var it = new DeferredIterator(options);\n\n    this._iterators.push(it);\n\n    return it;\n  };\n}\n\nDeferredLevelDOWN.prototype._serializeKey = function (key) {\n  return key;\n};\n\nDeferredLevelDOWN.prototype._serializeValue = function (value) {\n  return value;\n};\n\nmodule.exports = DeferredLevelDOWN;\nmodule.exports.DeferredIterator = DeferredIterator;","map":null,"metadata":{},"sourceType":"script"}